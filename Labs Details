SELECT q1.driver_name AS Supplier, COUNT(q1.driver_name) AS CountOfDistributionOperations, SUM(q1.dispensed_amount) AS TotalDistributionVolume FROM ( SELECT driver_name, tanker_plate, SUM(dispensed_amount) AS dispensed_amount FROM ( SELECT driver_name, tanker_plate, start_time, dispensed_amount, SUM(CASE WHEN diff_minutes IS NULL OR diff_minutes >= 60 THEN 1 ELSE 0 END) OVER (PARTITION BY driver_name,tanker_plate ORDER BY start_time) AS session_id FROM ( SELECT *, DATEDIFF(MINUTE, LAG(start_time) OVER (PARTITION BY driver_name,tanker_plate ORDER BY driver_name,start_time), start_time) AS diff_minutes FROM fuel_transactions WHERE OPERATION_TYPE_ID = 2 AND STATION_GUID not in ('9C98D9C8-C719-4C1C-B8F2-05B7C19AE567','9C8ADE1E-2EAF-40CA-BC24-2379BDE4AA26','9C94F65B-22D6-4D7A-9A73-D3ABBE17B302') -- small station guids AND start_time BETWEEN '3/1/2025 3:00:00 AM' AND '3/30/2025 3:00:00 AM' AND lower(DRIVER_LICENSE) not like 'transfer%') AS Differences ) AS Filtered GROUP BY driver_name,tanker_plate, session_id) q1 GROUP BY q1.driver_name
